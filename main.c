#include<STC32G.h>
#define u8 unsigned char
#define u16 unsigned int

const int code soundTrack1[] = {392 ,523 ,659 ,392 ,523 ,659 ,392 ,523 ,659 ,392 ,523 ,659 ,392 ,523 ,659 ,392 ,523 ,659 ,392 ,392 ,523 ,523 ,523 ,523 ,587 ,587 ,659 ,523 ,784 ,784 ,784 ,659 ,587 ,587 ,784 ,784 ,587 ,587 ,523 ,440 ,659 ,659 ,659 ,523 ,494 ,494 ,494 ,494 ,523 ,494 ,440 ,440 ,494 ,494 ,523 ,587 ,392 ,392 ,523 ,523 ,587 ,659 ,698 ,698 ,698 ,659 ,587 ,523 ,587 ,587 ,587 ,587 ,523 ,587 ,659 ,523 ,784 ,784 ,784 ,659 ,587 ,587 ,784 ,784 ,587 ,587 ,523 ,440 ,440 ,440 ,494 ,523 ,392 ,392 ,392 ,392 ,0 ,392 ,440 ,440 ,494 ,494 ,523 ,587 ,392 ,392 ,523 ,523 ,587 ,659 ,698 ,698 ,698 ,659 ,587 ,523 ,523 ,523 ,523 ,523 ,523 ,523 ,0 ,0 ,0 ,0 ,659 ,698 ,784 ,784 ,784 ,784 ,784 ,784 ,784 ,784 ,784 ,880 ,784 ,698 ,659 ,659 ,659 ,659 ,659 ,659 ,659 ,698 ,659 ,587 ,523 ,494 ,440 ,440 ,494 ,523 ,587 ,659 ,523 ,784 ,784 ,784 ,659 ,587 ,587 ,784 ,784 ,587 ,587 ,523 ,440 ,659 ,659 ,659 ,523 ,494 ,494 ,494 ,494 ,523 ,494 ,440 ,440 ,494 ,494 ,523 ,587 ,392 ,392 ,523 ,523 ,587 ,659 ,698 ,698 ,698 ,659 ,587 ,523 ,587 ,587 ,587 ,587 ,523 ,587 ,659 ,523 ,784 ,784 ,784 ,659 ,587 ,587 ,784 ,784 ,587 ,587 ,523 ,440 ,440 ,440 ,494 ,523 ,392 ,392 ,392 ,392 ,0 ,392 ,440 ,440 ,494 ,494 ,523 ,587 ,392 ,392 ,523 ,523 ,587 ,659 ,698 ,698 ,698 ,659 ,587 ,523 ,523 ,523 ,523 ,523 ,523 ,523 ,0 ,0 ,0 ,0 ,659 ,698 ,784 ,784 ,784 ,784 ,784 ,784 ,784 ,784 ,784 ,880 ,784 ,698 ,659 ,659 ,659 ,659 ,659 ,659 ,659 ,698 ,659 ,587 ,523 ,494 ,440 ,440 ,494 ,523 ,587 ,392 ,392 ,523 ,523 ,587 ,659 ,587 ,587 ,587 ,587 ,587 ,523 ,523 ,523 ,523 ,523 ,523 ,523 ,392 ,392 ,523 ,523 ,0 ,0 ,392 ,392 ,523 ,523 ,659 ,659 ,392 ,392 ,523 ,523 ,523 ,587 ,659 ,523 ,784 ,784 ,784 ,659 ,587 ,587 ,784 ,784 ,587 ,587 ,523 ,440 ,659 ,659 ,659 ,523 ,494 ,494 ,494 ,494 ,523 ,494 ,440 ,440 ,494 ,494 ,523 ,587 ,392 ,392 ,523 ,523 ,587 ,659 ,698 ,698 ,698 ,659 ,587 ,523 ,587 ,587 ,587 ,587 ,523 ,587 ,659 ,523 ,784 ,784 ,784 ,659 ,587 ,587 ,784 ,784 ,587 ,587 ,523 ,440 ,440 ,440 ,494 ,523 ,392 ,392 ,392 ,392 ,0 ,392 ,440 ,440 ,494 ,494 ,523 ,587 ,392 ,392 ,523 ,523 ,587 ,659 ,698 ,698 ,698 ,659 ,587 ,523 ,523 ,523 ,523 ,523 ,523 ,523 ,0 ,0 ,0 ,0 ,659 ,698 ,784 ,784 ,784 ,784 ,784 ,784 ,784 ,784 ,784 ,880 ,784 ,698 ,659 ,659 ,659 ,659 ,659 ,659 ,659 ,698 ,659 ,587 ,523 ,494 ,440 ,440 ,494 ,523 ,587 ,659 ,523 ,784 ,784 ,784 ,659 ,587 ,587 ,784 ,784 ,587 ,587 ,523 ,440 ,659 ,659 ,659 ,523 ,494 ,494 ,494 ,494 ,523 ,494 ,440 ,440 ,494 ,494 ,523 ,587 ,392 ,392 ,523 ,523 ,587 ,659 ,698 ,698 ,698 ,659 ,587 ,523 ,587 ,587 ,587 ,587 ,523 ,587 ,659 ,523 ,784 ,784 ,784 ,659 ,587 ,587 ,784 ,784 ,587 ,587 ,523 ,440 ,440 ,440 ,494 ,523 ,392 ,392 ,392 ,392 ,0 ,392 ,440 ,440 ,494 ,494 ,523 ,587 ,392 ,392 ,523 ,523 ,587 ,659 ,698 ,698 ,698 ,659 ,587 ,523 ,523 ,523 ,523 ,523 ,523 ,523 ,0 ,0 ,0 ,0 ,659 ,698 ,784 ,784 ,784 ,784 ,784 ,784 ,784 ,784 ,784 ,880 ,784 ,698 ,659 ,659 ,659 ,659 ,659 ,659 ,659 ,698 ,659 ,587 ,523 ,494 ,440 ,440 ,494 ,523 ,587 ,392 ,392 ,523 ,523 ,523 ,494 ,440 ,440 ,494 ,494 ,523 ,587 ,392 ,392 ,392 ,392 ,523 ,494 ,440 ,440 ,494 ,494 ,523 ,587 ,392 ,392 ,523 ,523 ,587 ,659 ,698 ,698 ,698 ,659 ,587 ,523 ,};


u16 rupt_ = 1;
u16 rupt_pre = 1;
	
void Timer0() interrupt 1
{
	rupt_ = 0;
}
	
void main()
{
	u16 len = 622;		//曲谱长度
	int speed = 240; // 120个音符代码每分钟
	
	int temp = 0;  //用于循环等工作的临时变量
	
	int time1 = 0;
	u16 local_time1 = 0;

	
	//20MHz = 20*10^6hz
	
	P0M0 = 0x00;
	P0M1 = 0x00;
	P1M0 = 0x00;
	P1M1 = 0x00;
	P2M0 = 0x00;
	P2M1 = 0x00;
	P3M0 = 0x00;
	P3M1 = 0x00;
	P4M0 = 0x00;
	P4M1 = 0x00;
	P5M0 = 0x00;
	P5M1 = 0x00;
	P6M0 = 0x00;
	P6M1 = 0x00;
	P7M0 = 0x00;
	P7M1 = 0x00;
	
	TMOD = 0x10;
	
	TL0 = 0xff;	//16位自动重载 10微妙终断一次
	TH0 = 0xeb;		
	TR0 = 1;				//start timer0
	ET0 = 0;				//先关闭中断
	EA = 1;
	
	
	
	//=========================
	P00 = 0;
	while(P00 == 0)	//按键判断开始
	{}
	P10 = 1;
	//主循环
	ET0 = 1;  //允许中断
	while(1)
	{
		// 播放
		for(temp = 0;temp<len;temp++)
		{
			local_time1 = (int)(50000.0 / (double)soundTrack1[temp]) ; 	//一半的周期 前一半是1 后一半是0 ,  这个代表 中断 times次后，蜂鸣器的输出端口的值应该改变( 有数学简化运算，所以式子看起来会有点怪)
			
			
			time1 = local_time1; //times 作为自减用的变量
			

			while(rupt_ <= (6000000/speed))  // 一次音符的时间到后，退出循环
			{
				if(rupt_pre != rupt_)	// 如果发生了中断
				{ rupt_pre = rupt_; time1--; } // 记录中断 times自减	
				
				if(time1 == 0)	//如果times减到0了 端口值变换
				{ 
					time1 = local_time1; 
					P10 = !P10;
				}
			}
			
			
		}
		
	}
}